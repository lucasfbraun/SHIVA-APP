import { useState, useEffect } from 'react';
import { Package, TrendingUp, Search, Calendar, FileText, ArrowDownCircle, ArrowUpCircle } from 'lucide-react';
import { produtoService } from '@/services/produtoService';
import { Produto } from '@/types';

export default function MovimentoEstoque() {
  const [produtos, setProdutos] = useState<Produto[]>([]);
  const [produtoSelecionado, setProdutoSelecionado] = useState<Produto | null>(null);
  const [tipoMovimento, setTipoMovimento] = useState<'ENTRADA' | 'SAIDA'>('ENTRADA');
  const [quantidade, setQuantidade] = useState('');
  const [custoUnitario, setCustoUnitario] = useState('');
  const [dataEntrada, setDataEntrada] = useState('');
  const [numeroCupom, setNumeroCupom] = useState('');
  const [observacao, setObservacao] = useState('');
  const [loading, setLoading] = useState(false);
  const [busca, setBusca] = useState('');

  useEffect(() => {
    loadProdutos();
    // Definir data atual como padrão
    const hoje = new Date().toISOString().split('T')[0];
    setDataEntrada(hoje);
  }, []);

  const loadProdutos = async () => {
    try {
      const data = await produtoService.getAll({ ativo: true, controlaEstoque: true });
      setProdutos(data);
    } catch (error) {
      console.error('Erro ao buscar produtos:', error);
    }
  };

  const produtosFiltrados = produtos.filter(p =>
    p.nome.toLowerCase().includes(busca.toLowerCase()) ||
    p.codigoInterno?.toLowerCase().includes(busca.toLowerCase()) ||
    p.codigoBarras?.toLowerCase().includes(busca.toLowerCase())
  );

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();

    if (!produtoSelecionado) {
      alert('Selecione um produto');
      return;
    }

    const qtd = parseFloat(quantidade);
    const custo = parseFloat(custoUnitario);

    if (!qtd || qtd <= 0) {
      alert('Quantidade deve ser maior que zero');
      return;
    }

    if (!Number.isInteger(qtd)) {
      alert('Quantidade deve ser um número inteiro');
      return;
    }

    // Validar custo unitário apenas para ENTRADA
    if (tipoMovimento === 'ENTRADA' && (!custo || custo < 0)) {
      alert('Custo unitário deve ser informado');
      return;
    }

    // Validar estoque para saída
    if (tipoMovimento === 'SAIDA') {
      const estoqueAtual = produtoSelecionado.estoque?.quantidade || 0;
      if (qtd > estoqueAtual) {
        alert(`Estoque insuficiente!\n\nDisponível: ${estoqueAtual} unidades\nSolicitado: ${qtd} unidades`);
        return;
      }
    }

    try {
      setLoading(true);
      // Para SAIDA, usar custo médio do produto se não informado
      const custoFinal = tipoMovimento === 'SAIDA' && !custo 
        ? produtoSelecionado.custoMedio || 0
        : custo;
      
      await produtoService.registrarEntradaEstoque({
        produtoId: produtoSelecionado.id,
        quantidade: qtd,
        custoUnitario: custoFinal,
        dataEntrada,
        numeroCupom: tipoMovimento === 'ENTRADA' ? (numeroCupom || undefined) : undefined,
        observacao: observacao || undefined,
        tipoMovimento
      });

      const mensagem = tipoMovimento === 'ENTRADA'
        ? `Entrada registrada com sucesso!\n\n${qtd} unidades de "${produtoSelecionado.nome}" adicionadas ao estoque.`
        : `Saída registrada com sucesso!\n\n${qtd} unidades de "${produtoSelecionado.nome}" removidas do estoque.`;
      
      alert(mensagem);
      
      // Limpar form
      setProdutoSelecionado(null);
      setQuantidade('');
      setCustoUnitario('');
      setNumeroCupom('');
      setObservacao('');
      setBusca('');
      setTipoMovimento('ENTRADA');
      
      // Resetar data para hoje
      const hoje = new Date().toISOString().split('T')[0];
      setDataEntrada(hoje);
      
      // Recarregar produtos para atualizar estoque
      loadProdutos();
    } catch (error: any) {
      console.error('Erro ao registrar movimento:', error);
      alert(error.response?.data?.error || 'Erro ao registrar movimento de estoque');
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="container-main px-4 md:px-8 py-8">
      <div className="mb-8">
        <h1 className="font-title text-3xl md:text-4xl font-bold text-text-primary mb-2">
          Movimento de Estoque
        </h1>
        <p className="text-text-secondary">
          Registre entradas e saídas de produtos no estoque
        </p>
      </div>

      <div className="card max-w-3xl mx-auto">
        <form onSubmit={handleSubmit} className="space-y-6">
          {/* Seleção de Produto */}
          <div>
            <label className="block text-sm font-medium text-text-primary mb-2">
              <Package className="inline mr-2" size={16} />
              Produto *
            </label>
            
            {!produtoSelecionado ? (
              <>
                <div className="relative mb-3">
                  <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-text-secondary" size={20} />
                  <input
                    type="text"
                    placeholder="Buscar produto por nome, código interno ou código de barras..."
                    value={busca}
                    onChange={(e) => setBusca(e.target.value)}
                    className="input pl-10 w-full"
                  />
                </div>

                <div className="max-h-60 overflow-y-auto space-y-2 border border-purple-primary/30 rounded-lg p-2">
                  {produtosFiltrados.length === 0 ? (
                    <p className="text-text-secondary text-center py-4">
                      {busca ? 'Nenhum produto encontrado' : 'Nenhum produto cadastrado'}
                    </p>
                  ) : (
                    produtosFiltrados.map((produto) => (
                      <button
                        key={produto.id}
                        type="button"
                        onClick={() => {
                          setProdutoSelecionado(produto);
                          setCustoUnitario('');
                        }}
                        className="w-full text-left p-3 rounded-lg hover:bg-purple-primary/10 transition border border-transparent hover:border-purple-primary/50"
                      >
                        <div className="font-medium text-text-primary">{produto.nome}</div>
                        <div className="text-sm text-text-secondary mt-1 space-y-1">
                          {produto.codigoInterno && (
                            <div>Código: {produto.codigoInterno}</div>
                          )}
                          {produto.codigoBarras && (
                            <div>Barras: {produto.codigoBarras}</div>
                          )}
                          <div className="flex gap-4">
                            <span>Estoque: {produto.estoque?.quantidade || 0} un</span>
                            <span>Custo Médio: R$ {produto.custoMedio?.toFixed(2) || '0.00'}</span>
                          </div>
                        </div>
                      </button>
                    ))
                  )}
                </div>
              </>
            ) : (
              <div className="p-4 bg-purple-primary/10 rounded-lg border border-purple-primary/30">
                <div className="flex justify-between items-start">
                  <div>
                    <div className="font-medium text-text-primary text-lg">{produtoSelecionado.nome}</div>
                    <div className="text-sm text-text-secondary mt-2 space-y-1">
                      {produtoSelecionado.codigoInterno && (
                        <div>Código: {produtoSelecionado.codigoInterno}</div>
                      )}
                      {produtoSelecionado.codigoBarras && (
                        <div>Barras: {produtoSelecionado.codigoBarras}</div>
                      )}
                      <div>Estoque atual: {produtoSelecionado.estoque?.quantidade || 0} un</div>
                      <div>Custo médio atual: R$ {produtoSelecionado.custoMedio?.toFixed(2) || '0.00'}</div>
                    </div>
                  </div>
                  <button
                    type="button"
                    onClick={() => {
                      setProdutoSelecionado(null);
                      setCustoUnitario('');
                    }}
                    className="text-red-action hover:text-red-action/80 text-sm"
                  >
                    Trocar
                  </button>
                </div>
              </div>
            )}
          </div>

          {produtoSelecionado && (
            <>
              {/* Tipo de Movimento */}
              <div>
                <label className="block text-sm font-medium text-text-primary mb-3">
                  Tipo de Movimento *
                </label>
                <div className="grid grid-cols-2 gap-4">
                  <button
                    type="button"
                    onClick={() => setTipoMovimento('ENTRADA')}
                    className={`p-4 rounded-lg border-2 transition-all ${
                      tipoMovimento === 'ENTRADA'
                        ? 'border-green-action bg-green-action/10 text-green-action'
                        : 'border-border bg-background-secondary text-text-secondary hover:border-green-action/50'
                    }`}
                  >
                    <ArrowDownCircle className="mx-auto mb-2" size={32} />
                    <div className="font-semibold">Entrada</div>
                    <div className="text-xs mt-1">Adicionar ao estoque</div>
                  </button>
                  <button
                    type="button"
                    onClick={() => setTipoMovimento('SAIDA')}
                    className={`p-4 rounded-lg border-2 transition-all ${
                      tipoMovimento === 'SAIDA'
                        ? 'border-red-action bg-red-action/10 text-red-action'
                        : 'border-border bg-background-secondary text-text-secondary hover:border-red-action/50'
                    }`}
                  >
                    <ArrowUpCircle className="mx-auto mb-2" size={32} />
                    <div className="font-semibold">Saída</div>
                    <div className="text-xs mt-1">Remover do estoque</div>
                  </button>
                </div>
              </div>

              {/* Data do Movimento */}
              <div>
                <label className="block text-sm font-medium text-text-primary mb-2">
                  <Calendar className="inline mr-2" size={16} />
                  Data do Movimento *
                </label>
                <input
                  type="date"
                  value={dataEntrada}
                  onChange={(e) => setDataEntrada(e.target.value)}
                  className="input w-full"
                  required
                />
              </div>

              {/* Número do Cupom - apenas para ENTRADA */}
              {tipoMovimento === 'ENTRADA' && (
                <div>
                  <label className="block text-sm font-medium text-text-primary mb-2">
                    <FileText className="inline mr-2" size={16} />
                    Número do Cupom Fiscal (opcional)
                  </label>
                  <input
                    type="text"
                    value={numeroCupom}
                    onChange={(e) => setNumeroCupom(e.target.value)}
                    className="input w-full"
                    placeholder="Ex: 12345"
                  />
                </div>
              )}

              {/* Quantidade */
              <div>
                <label className="block text-sm font-medium text-text-primary mb-2">
                  <TrendingUp className="inline mr-2" size={16} />
                  Quantidade *
                </label>
                <input
                  type="number"
                  step="1"
                  min="1"
                  value={quantidade}
                  onChange={(e) => setQuantidade(e.target.value)}
                  className="input w-full"
                  placeholder="Ex: 10"
                  required
                />
                <p className="text-xs text-text-secondary mt-1">
                  Apenas valores inteiros
                  {tipoMovimento === 'SAIDA' && produtoSelecionado && (
                    <span className="ml-2 text-orange-action font-medium">
                      • Disponível: {produtoSelecionado.estoque?.quantidade || 0} un
                    </span>
                  )}
                </p>
              </div>

              {tipoMovimento === 'ENTRADA' && (
                <div>
                  <label className="block text-sm font-medium text-text-primary mb-2">
                    Custo Unitário (R$) *
                  </label>
                  <input
                    type="number"
                    step="0.01"
                    min="0"
                    value={custoUnitario}
                    onChange={(e) => setCustoUnitario(e.target.value)}
                    className="input w-full"
                    placeholder="Ex: 15.50"
                    required
                  />
                  <p className="text-xs text-text-secondary mt-1">
                    O custo médio será recalculado automaticamente
                  </p>
                </div>
              )}

              {quantidade && (tipoMovimento === 'ENTRADA' ? custoUnitario : produtoSelecionado?.custoMedio) && (
                <div className={`p-4 rounded-lg border ${
                  tipoMovimento === 'ENTRADA'
                    ? 'bg-green-action/10 border-green-action/30'
                    : 'bg-red-action/10 border-red-action/30'
                }`}>
                  <div className="text-sm text-text-secondary">
                    Valor Total {tipoMovimento === 'ENTRADA' ? 'da Entrada' : 'da Saída'}
                  </div>
                  <div className={`text-2xl font-bold ${
                    tipoMovimento === 'ENTRADA' ? 'text-green-action' : 'text-red-action'
                  }`}>
                    R$ {(parseFloat(quantidade) * (tipoMovimento === 'ENTRADA' ? parseFloat(custoUnitario) : (produtoSelecionado?.custoMedio || 0))).toFixed(2)}
                  </div>
                  <div className="text-xs text-text-secondary mt-1">
                    {quantidade} unidades × R$ {(tipoMovimento === 'ENTRADA' ? parseFloat(custoUnitario) : (produtoSelecionado?.custoMedio || 0)).toFixed(2)}
                    {tipoMovimento === 'SAIDA' && ' (custo médio)'}
                  </div>
                </div>
              )}

              {/* Observação */}
              <div>
                <label className="block text-sm font-medium text-text-primary mb-2">
                  Observação (opcional)
                </label>
                <textarea
                  value={observacao}
                  onChange={(e) => setObservacao(e.target.value)}
                  className="input w-full"
                  rows={3}
                  placeholder="Ex: Nota fiscal 12345, Fornecedor XYZ..."
                />
              </div>

              {/* Botões */}
              <div className="flex gap-4">
                <button
                  type="submit"
                  disabled={loading}
                  className={tipoMovimento === 'ENTRADA' ? 'btn-primary flex-1' : 'btn-danger flex-1'}
                >
                  {loading 
                    ? 'Registrando...' 
                    : tipoMovimento === 'ENTRADA' 
                      ? 'Registrar Entrada' 
                      : 'Registrar Saída'
                  }
                </button>
                <button
                  type="button"
                  onClick={() => {
                    setProdutoSelecionado(null);
                    setQuantidade('');
                    setCustoUnitario('');
                    setNumeroCupom('');
                    setObservacao('');
                  }}
                  className="btn-secondary px-6"
                >
                  Cancelar
                </button>
              </div>
            </>
          )}
        </form>
      </div>
    </div>
  );
}
