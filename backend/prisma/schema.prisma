generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Usuario {
  id              String   @id @default(uuid())
  email           String   @unique
  senha           String
  nome            String
  ativo           Boolean  @default(true)
  criadoEm        DateTime @default(now())
  atualizadoEm    DateTime @updatedAt

  @@map("usuarios")
}

model Produto {
  id              String   @id @default(uuid())
  nome            String
  descricao       String?
  categoria       String?
  codigoInterno   String?  @unique
  codigoBarras    String?
  unidadeMedida   String   @default("UN") // UN, KG, G, ML, L
  quantidadeRefCalculo Float @default(1) // Quantidade para referência de cálculo de custo
  custoMedio      Float    @default(0)
  precoVenda      Float
  imagemUrl       String?
  markup          Float?   @default(0)
  tipo            String   @default("COMPRADO") // COMPRADO, FABRICADO
  controlaEstoque Boolean  @default(true)
  ativo           Boolean  @default(true)
  criadoEm        DateTime @default(now())
  atualizadoEm    DateTime @updatedAt

  estoque         Estoque?
  entradasEstoque EntradaEstoque[]
  itensComanda    ItemComanda[]
  itensVenda      ItemVenda[]
  engenharias     EngenhariaProduto[] @relation("ProdutoComponente")
  engenhariasParent EngenhariaProduto[] @relation("ProdutoPrincipal")
  
  @@map("produtos")
}

model Estoque {
  id              String   @id @default(uuid())
  produtoId       String   @unique
  quantidade      Float    @default(0)
  atualizadoEm    DateTime @updatedAt

  produto         Produto  @relation(fields: [produtoId], references: [id], onDelete: Cascade)
  
  @@map("estoques")
}

model EntradaEstoque {
  id              String   @id @default(uuid())
  produtoId       String
  quantidade      Float
  custoUnitario   Float
  dataEntrada     DateTime
  numeroCupom     String?
  tipoEntrada     String   @default("MANUAL") // MANUAL, OCR
  tipoMovimento   String   @default("ENTRADA") // ENTRADA, SAIDA
  comandaId       String?
  observacao      String?
  criadoEm        DateTime @default(now())

  produto         Produto  @relation(fields: [produtoId], references: [id], onDelete: Cascade)
  comanda         Comanda? @relation(fields: [comandaId], references: [id], onDelete: SetNull)
  
  @@map("entradas_estoque")
}

model Comanda {
  id              String   @id @default(uuid())
  numeroComanda   Int      @unique
  clienteId       String?
  nomeCliente     String
  status          String   @default("ABERTA") // ABERTA, FECHADA, CANCELADA
  total           Float    @default(0)
  valorPago       Float    @default(0)
  valorRestante   Float    @default(0)
  desconto        Float    @default(0)
  tipoDesconto    String   @default("VALOR") // VALOR, PERCENTUAL
  dataAbertura    DateTime @default(now())
  dataFechamento  DateTime?
  observacao      String?

  itens           ItemComanda[]
  entradasEstoque EntradaEstoque[]
  cliente         Cliente? @relation(fields: [clienteId], references: [id], onDelete: SetNull)
  
  @@map("comandas")
}

model Cliente {
  id              String   @id @default(uuid())
  nomeCompleto    String
  telefone        String?
  cpf             String?  @unique
  totalGasto      Float    @default(0)
  qtdComandas     Int      @default(0)
  ativo           Boolean  @default(true)
  criadoEm        DateTime @default(now())
  atualizadoEm    DateTime @updatedAt

  comandas        Comanda[]
  vendas          Venda[]
  sinucaPartidasA SinucaPartida[] @relation("SinucaPartidaClienteA")
  sinucaPartidasB SinucaPartida[] @relation("SinucaPartidaClienteB")
  sinucaPartidasVencidas SinucaPartida[] @relation("SinucaPartidaVencedor")
  sinucaTorneioParticipacoes SinucaTorneioParticipante[]
  sinucaTorneioPartidasA SinucaTorneioPartida[] @relation("SinucaTorneioPartidaClienteA")
  sinucaTorneioPartidasB SinucaTorneioPartida[] @relation("SinucaTorneioPartidaClienteB")
  sinucaTorneioPartidasVencidas SinucaTorneioPartida[] @relation("SinucaTorneioPartidaVencedor")
  
  @@map("clientes")
}

model ItemComanda {
  id              String   @id @default(uuid())
  comandaId       String
  produtoId       String
  nomeProduto     String   // Snapshot do nome no momento da venda
  quantidade      Float
  precoUnitario   Float
  custoUnitario   Float   @default(0) // Snapshot do custo médio no momento da venda
  subtotal        Float
  pago            Boolean  @default(false)
  abonado         Boolean  @default(false) // Item abonado (não conta no faturamento)
  criadoEm        DateTime @default(now())

  comanda         Comanda  @relation(fields: [comandaId], references: [id], onDelete: Cascade)
  produto         Produto  @relation(fields: [produtoId], references: [id])
  
  @@map("itens_comanda")
}

model OCRCupom {
  id              String   @id @default(uuid())
  imagemUrl       String
  status          String   @default("PENDENTE") // PENDENTE, PROCESSADO, ERRO
  itensDetectados String?  // JSON com os itens
  criadoEm        DateTime @default(now())
  processadoEm    DateTime?
  
  @@map("ocr_cupons")
}

model Despesa {
  id              String   @id @default(uuid())
  descricao       String
  valor           Float
  categoria       String   // aluguel, água, luz, combustível, etc
  tipo            String   @default("VARIÁVEL") // FIXA, VARIÁVEL
  data            DateTime // data do lançamento
  isRecorrente    Boolean  @default(false)
  mesesRecorrencia Int? // quantos meses a despesa fixa vai se repetir
  mesInicio       Int? // mês de início (1-12)
  anoInicio       Int? // ano de início
  observacao      String?
  paga            Boolean  @default(false)
  dataPagamento   DateTime?
  criadoEm        DateTime @default(now())
  atualizadoEm    DateTime @updatedAt

  @@map("despesas")
  @@index([data])
  @@index([tipo])
}

model EngenhariaProduto {
  id                String   @id @default(uuid())
  produtoId         String   
  componenteId      String   
  quantidade        Float
  criadoEm          DateTime @default(now())
  atualizadoEm      DateTime @updatedAt

  produto           Produto  @relation("ProdutoPrincipal", fields: [produtoId], references: [id], onDelete: Cascade)
  componente        Produto  @relation("ProdutoComponente", fields: [componenteId], references: [id], onDelete: Cascade)

  @@unique([produtoId, componenteId])
  @@map("engenharia_produtos")
}

model Venda {
  id              String   @id @default(uuid())
  numeroVenda     Int      @unique
  clienteId       String?
  nomeCliente     String?
  status          String   @default("ABERTA") // ABERTA, FINALIZADA, CANCELADA
  subtotal        Float    @default(0)
  desconto        Float    @default(0)
  tipoDesconto    String   @default("VALOR") // VALOR, PERCENTUAL
  total           Float    @default(0)
  valorPago       Float    @default(0)
  valorRestante   Float    @default(0)
  tipoPagamento   String   @default("DINHEIRO") // DINHEIRO, CARTAO, FIADO
  dataAbertura    DateTime @default(now())
  dataFechamento  DateTime?
  observacao      String?

  itens           ItemVenda[]
  cliente         Cliente? @relation(fields: [clienteId], references: [id], onDelete: SetNull)

  @@map("vendas")
}

model ItemVenda {
  id              String   @id @default(uuid())
  vendaId         String
  produtoId       String
  nomeProduto     String   // Snapshot do nome no momento da venda
  quantidade      Float
  precoUnitario   Float
  custoUnitario   Float    @default(0) // Snapshot para lucro
  desconto        Float    @default(0)
  tipoDesconto    String   @default("VALOR") // VALOR, PERCENTUAL
  subtotal        Float
  criadoEm        DateTime @default(now())

  venda           Venda    @relation(fields: [vendaId], references: [id], onDelete: Cascade)
  produto         Produto  @relation(fields: [produtoId], references: [id])

  @@map("itens_venda")
}

model SinucaPartida {
  id           String   @id @default(uuid())
  tipo         String   @default("UNICA") // UNICA, MELHOR_DE
  melhorDe     Int      @default(1)
  clienteAId   String
  clienteBId   String
  vitoriasA    Int      @default(0)
  vitoriasB    Int      @default(0)
  status       String   @default("PENDENTE") // PENDENTE, EM_ANDAMENTO, FINALIZADA, CANCELADA
  vencedorId   String?
  observacao   String?
  iniciadoEm   DateTime?
  finalizadoEm DateTime?
  criadoEm     DateTime @default(now())
  atualizadoEm DateTime @updatedAt

  clienteA     Cliente  @relation("SinucaPartidaClienteA", fields: [clienteAId], references: [id])
  clienteB     Cliente  @relation("SinucaPartidaClienteB", fields: [clienteBId], references: [id])
  vencedor     Cliente? @relation("SinucaPartidaVencedor", fields: [vencedorId], references: [id])

  @@map("sinuca_partidas")
}

model SinucaTorneio {
  id           String   @id @default(uuid())
  nome         String
  tipo         String   @default("TODOS_CONTRA_TODOS") // TODOS_CONTRA_TODOS, CHAVEAMENTO
  melhorDe     Int      @default(3)
  status       String   @default("RASCUNHO") // RASCUNHO, EM_ANDAMENTO, FINALIZADO
  criadoEm     DateTime @default(now())
  atualizadoEm DateTime @updatedAt

  participantes SinucaTorneioParticipante[]
  partidas      SinucaTorneioPartida[]

  @@map("sinuca_torneios")
}

model SinucaTorneioParticipante {
  id         String   @id @default(uuid())
  torneioId  String
  clienteId  String
  pontos     Int      @default(0)
  vitorias   Int      @default(0)
  derrotas   Int      @default(0)
  criadoEm   DateTime @default(now())

  torneio    SinucaTorneio @relation(fields: [torneioId], references: [id], onDelete: Cascade)
  cliente    Cliente       @relation(fields: [clienteId], references: [id])

  @@unique([torneioId, clienteId])
  @@map("sinuca_torneio_participantes")
}

model SinucaTorneioPartida {
  id         String   @id @default(uuid())
  torneioId  String
  rodada     Int
  clienteAId String
  clienteBId String
  vitoriasA  Int      @default(0)
  vitoriasB  Int      @default(0)
  status     String   @default("PENDENTE") // PENDENTE, EM_ANDAMENTO, FINALIZADA, CANCELADA
  vencedorId String?
  melhorDe   Int
  criadoEm   DateTime @default(now())
  atualizadoEm DateTime @updatedAt

  torneio    SinucaTorneio @relation(fields: [torneioId], references: [id], onDelete: Cascade)
  clienteA   Cliente       @relation("SinucaTorneioPartidaClienteA", fields: [clienteAId], references: [id])
  clienteB   Cliente       @relation("SinucaTorneioPartidaClienteB", fields: [clienteBId], references: [id])
  vencedor   Cliente?      @relation("SinucaTorneioPartidaVencedor", fields: [vencedorId], references: [id])

  @@map("sinuca_torneio_partidas")
}
